{% extends "base.html" %}

{% block content %}
  <section class="card">
    <h2>Manage Bookings</h2>
    <p class="meta">
      Filter by any column content and approve or deny pending bookings.
    </p>
    <form method="get" class="form form-inline">
      <label class="field">
        Filter
        <input type="text" name="q" value="{{ query }}" placeholder="Search bookings" />
      </label>
      <button type="submit" class="button button-secondary">Apply filter</button>
    </form>
  </section>
  <section class="card table-card">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Project</th>
          <th>Timeslot</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
          <tr>
            <td>{{ booking.email }}</td>
            <td>{{ booking.first_name }} {{ booking.last_name }}</td>
            <td>{{ booking.project }}</td>
            <td>{{ booking.timeslot_raw }}</td>
            <td>
              <span class="status">
                {{ status_labels.get(booking.status, booking.status) }}
              </span>
            </td>
            <td>
              {% if booking.status in ["pending_review", "zu_ueberpruefen"] %}
                <form method="post" class="inline-actions">
                  <input type="hidden" name="booking_id" value="{{ booking.id }}" />
                  <button class="button button-small" name="action" value="approve">
                    Confirm
                  </button>
                  <button class="button button-small button-secondary" name="action" value="deny">
                    Deny
                  </button>
                  <label class="checkbox">
                    <input type="checkbox" name="send_response" value="yes" />
                    Send email automatically
                  </label>
                </form>
              {% elif booking.status in ["gebucht", "denied"] %}
                <a
                  class="button button-small button-secondary"
                  href="{{ url_for('bookings_manage', q=query, show_booking_id=booking.id) }}"
                >
                  Show email text
                </a>
              {% else %}
                <span class="meta">No action</span>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="meta">No bookings found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% if booking_preview %}
    <section class="card">
      <h3>Booking response preview</h3>
      <p class="meta">
        Use this content to respond to the booking request.
      </p>
      <div class="form">
        <label class="field">
          Recipient
          <input type="text" value="{{ booking_preview.email }}" readonly />
        </label>
        <label class="field">
          Subject
          <input type="text" value="{{ booking_preview.subject }}" readonly />
        </label>
        <label class="field">
          Body
          <textarea rows="10" readonly>{{ booking_preview.body }}</textarea>
        </label>
      </div>
      {% if booking_preview.email %}
        <form method="post" class="inline-actions">
          <input type="hidden" name="booking_id" value="{{ booking_preview.booking_id }}" />
          <button class="button button-small" name="action" value="send_response">
            Send response
          </button>
        </form>
      {% else %}
        <p class="meta">No email is linked to this booking.</p>
      {% endif %}
    </section>
  {% endif %}
  <a class="link" href="{{ url_for('bookings') }}">Back to bookings</a>
{% endblock %}
